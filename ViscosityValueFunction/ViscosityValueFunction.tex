
\chapter{Continuous value functions}

	\section{Generalizing the total derivative}
	
	The example from section \ref{non-smooth} underlines that it is impractical to assume the value function to be smooth. We therefore distill the key features of classical derivatives that underpinned theorem \ref{classical solution HJB} and the subsequent comparison results. In view of our undertaking,  lemma \ref{extension lemma} proves insightful. There, we applied Fermat's rule to interchange the derivative of the subsolution $ w $ with the derivative of the test function $ \varphi $. It is exactly this feature we want to preserve. Hence the following definition.
	
	\begin{definition}
		Let $ \Omega \subset \mathbb{R}^N $ be an open domain. A real-valued continuous function $ u : \Omega \to \mathbb{R} $ is called a \emph{viscosity subsolution} of $ F : \Omega \times \mathbb{R} \times \mathbb{R}^N \to \mathbb{R} $, if for any smooth function $ \varphi \in C^1(\Omega) $, we have that
		
		\begin{equation}
			\label{def viscosity subsolution}
			F(x_0, u(x_0), D \varphi(x_0)) \leq 0 \ ,
		\end{equation}
		whenever $ u - \varphi $ attains a local \emph{maximum} in $ x_0 \in \Omega $.
		
		Respectively, we call $ u $ a \emph{viscosity supersolution} of $ F $, if
		
		\begin{equation}
			\label{def viscosity supersolution}
			F(x_0, u(x_0), D\varphi(x_0)) \geq 0
		\end{equation}
		whenever $ u - \varphi $ attains local \emph{minimum} in $ x_0 \in \Omega $. 
		
		We finally call $ u $ a \emph{viscosity solution} of $ F $, if it is a viscosity sub-and supersolution of $ F $.
	\end{definition}

	For convenience, we introduce an additional definition to denote the sets of derivatives, generated by such smooth test functions.
	
	\begin{definition}
		\label{semidifferentials}
		Let $ \Omega \subset \mathbb{R}^N $ be an open domain and $ u : \Omega \to \mathbb{R} $ a real-valued, continuous function. Consider a point $ x_0 \in \Omega $. 
		
		A vector $ p \in \mathbb{R}^N $ is termed a \emph{superdifferential} of $ u $ in $ x_0 $, if there exists a smooth function $ \varphi \in C^{1}(\Omega) $, s.t. $ u - \varphi $ attains a local \emph{maxmium} in $ x_0 $, and $ p = D \varphi(x_0) $. The set of all superdifferentials is denoted by $ D^{+}u(x_0) $ .
		
		Analogously, a vector $ p \in \mathbb{R}^N $ is termed a \emph{subdifferential} of $ u $ in $ x_0 $, if there exists a smooth function $ \varphi \in C^{1}(\Omega) $, s.t. $ u - \varphi $ attains a local \emph{minimum} in $ x_0 $, and $ p = D \varphi(x_0) $. The set of all subdifferentials is denoted by $ D^{-}u(x_0) $.
	\end{definition}

	\begin{remark}
		Usually, the sets of sub- and superdifferentials are defined as
		
		\begin{align*}
			D^{+} u(x) &\coloneqq \bigg\{p \in \mathbb{R}^N : \limsup\limits_{y \to x, y \in \Omega} \frac{u(y) - \left[u(x) + p(y - x) \right]}{\normof{y - x}} \leq 0 \bigg\} \\
			D^{-} u(x) &\coloneqq \bigg\{p \in \mathbb{R}^N : \liminf\limits_{y \to x, y \in \Omega} \frac{u(y) - \left[u(x) + p(y - x) \right]}{\normof{y - x}} \geq 0 \bigg\} \ .
		\end{align*}
		
		According to \cite[lemma 1.7, p.~29]{bardi2008optimal} definition \ref{semidifferentials} coincides with the usual definition. The latter proves more convenient when deriving rules of calculus within our new framework \cite[cf. p.~37 et sqq]{bardi2008optimal}. As we are primarily interested in the comparison with smooth functions, we stick with definition \ref{semidifferentials}.
	\end{remark}

	Viscosity solutions would not be of interest to us, if the value function were not a viscosity solution of \eqref{HJB}.
	
	\begin{theorem}
		\label{viscosity solution HJB}
		Suppose the same assumptions as in theorem \ref{classical solution HJB} hold, except for the smoothness of the value function $ v $. Then $ v $ is a viscosity solution of \eqref{HJB}.
		
		\begin{proof}
			The proof of theorem \ref{classical solution HJB} only requires minor modifications.
			
			We have already proved in \ref{value lipschitz} that $ v $ is locally Lipschitz-continuous, and consequently continuous under the given assumptions.
			
			To show that $ v $ is a viscosity subsolution of \eqref{HJB}, note that
			
			\begin{equation*}
				\varphi(t, x) - \varphi(t_0, x_0) \geq v(t, x) - v(t_0, x_0) \ ,
			\end{equation*}
			
			holds in a sufficiently small neighbourhood of $ (t_0, x_0) $, whenever $ v - \varphi $ attains a local maximum in $ (t_0, x_0) $.
			The left-hand-side of \eqref{diff_quotient_sub}, can therefore be replaced by
			
			\begin{equation*}
				\frac{\varphi(t_0 + h, x^{\overline{a}}_{x_0}(t_0 + h)) - \varphi(t_0, x_0)}{h} \ .
			\end{equation*}
			Now proceed as in theorem \ref{classical solution HJB} to show that $ v $ is viscosity subsolution of \eqref{HJB}.
			
			We proceed in a similar manner when proving that $ v $ a supersolution of \eqref{HJB}. However, an additional technical detail has to be taken into account. Recall the proof of $ v $ being a supersolution, when it is smooth. There, we have considered a whole family of trajectories $ x_{x_0}^{\alpha} $, all satisfying the same initial condition $ x(t_0) = x_0 $, w.r.t. to different controls $ \alpha = \alpha(h) $. Once again we seek to replace the left-hand side of \eqref{diff_quotient_super}, by

			\begin{equation*}
				\frac{\varphi(t_0 + h, x^{\alpha}_{x_0}(t_0 + h)) - \varphi(t_0, x_0)}{h} \ ,
			\end{equation*}
			using the fact that $ v - \varphi $ attains a local minimum in $ (t_0, x_0) $.
			But as $ (t_0, x_0) $ is only known to be a \emph{local} minimum, the substitution only works if $ x^{\alpha}_{x_0}(t_0 + h) $ is close enough to $ x_0 $. We therefore need the equicontinuity of all trajectories $ x^{\alpha}_{x_0} $ in $ t_0 $. In view of \eqref{trajectory equicontinuous}, this is clearly the case.
		\end{proof}
	\end{theorem}

	Up to now, the notion of viscosity solutions, first introduced in \cite{lions} by M.G. Crandall and P.L. Lions, seems to fit our needs. Of course we still have to check whether the comparison and uniqueness results, proven in the smooth case, apply to viscosity solutions.
	
	\section{From classical solutions to viscosity solutions}
	Our goal is to transfer the results proven for classical solutions, namely lemma \ref{extension lemma}, theorem \ref{smooth_loc} and corollary \ref{Smooth Uniqueness} to viscosity solutions. We start with lemma \ref{extension lemma}.
	
	\begin{lemma}
		\label{extension lemma viscosity}
		Let $ \Omega^{\prime} \subset \mathbb{R}^{N-1} $ be an open domain. Set $ \Omega \coloneqq \left( a, b \right) \times \Omega^{\prime} $. Suppose $ w \in C (\overline{\Omega})$ is a viscosity subsolution of
		
		\begin{equation*}
		F(t, x, w, Dw) = 0
		\end{equation*}
		in $ \Omega $, where $ F : \left[ a, b \right) \times \Omega^{\prime} \times \mathbb{R} \times \mathbb{R}^{N} \to \mathbb{R} $ is a continuous function, and the mapping
		
		\begin{equation*}
		s \mapsto F(t, x, r, s, p_1, \ldots, p_{N-1})
		\end{equation*}
		is non-increasing for every $ (t, x, r, p_1, \ldots, p_{N-1}) $. Let $ \varphi \in C^{1} \left( \Omega \right) $, s.t. its total differential continuously extends to $ \left[a, b\right) \times \Omega^{\prime} $.
		
		If $ w - \varphi $ attains a local maximum in some point $ \overlinedPair{t}{x} \in \left[a, b\right) \times \Omega^{\prime} $, then
		
		\begin{equation*}
		F(\overline{t}, \overline{x}, w\overlinedPair{t}{x}, D\varphi\overlinedPair{t}{x})) \leq 0.
		\end{equation*}
		
		\begin{proof}
			The claim holds immediately for interior local extrema by definition of viscosity subsolutions, substituting for Fermat's rule applied to smooth subsolutions. We adopt verbatim the arguments applied to maxima located in $ \{a\} \times \mathbb{R}^N $.
		\end{proof}
	\end{lemma}

	Now for theorem \ref{smooth_loc}. Its proof consisted of exactly two steps: firstly showing that the difference $ w $ is a subsolution of the equation
	
	\begin{equation*}
		-w_t - C \lvert D_x w \rvert \leq 0 \ ,
	\end{equation*}
	
	and secondly, comparing $ w $ to strict supersolutions of the same equation. Latter step was based on lemma \ref{extension lemma} which has already been extended to continuous viscosity subsolutions in lemma \ref{extension lemma viscosity}. In contrast, adapting the first step entails a major issue. 

	\subsection{A naive approach}
		\label{naive}
		
		We wish to show that $ w \coloneqq u - v $ is a viscosity subsolution of \eqref{diff-PDE}, provided that $ u $ and $ v $ are viscosity sub-and supersolutions of
		
		\begin{equation*}
				-u_t + H(t, x, -D_x u) = 0 \ ,
		\end{equation*}
		
		respectively. To this end, suppose we are given an arbitrary subdifferential in some point $ (t_0, x_0) $. We naively follow the approach adopted for smooth solutions. That is, we try to rewrite the subdifferential of $ w $ as the difference of a subdifferential of $ u $, and a superdifferential of $ v $ in the \emph{same} point $ (t_0, x_0) $. This approach proves too optimistic, as we consider the continuous function
		
		\begin{align*}
			f : \mathbb{R} &\to \mathbb{R} \\
			r &\mapsto \begin{cases}
			\lvert r \rvert^{1/2} \sin(\frac{1}{r^2}), &\hbox{ if } r \neq 0 \\
			0 &\hbox{ if } r = 0  \ ,
			\end{cases}
		\end{align*}
		
		taken from \cite[p.~32, exercise 1.5]{bardi2008optimal}. Suppose for the sake of contradiction that $ Df^{+}(0) $ is not empty. Then, there exists a function $ \varphi \in C^1(\mathbb{R}) $, such that $ f - \varphi $ attains a local maximum in zero, i.e.
		
		\begin{equation*}
			f(0) - f(0 + h) \geq \varphi(0) - \varphi(0 + h)  \ ,
		\end{equation*}
		for small $ h $. For strictly positive $ h $, we additionally get
		
		\begin{equation*}
			\frac{f( 0 + h) - f(0)}{h} \leq \frac{\varphi(0 + h) - \varphi(0)}{h} \ ,
		\end{equation*}
		
		and consequently 
		
		\begin{equation*}
			\limsup\limits_{h \searrow 0} \frac{f( 0 + h) - f(0)}{h} \leq \limsup\limits_{h \searrow 0} \frac{\varphi(0 + h) - \varphi(0)}{h} \ .
		\end{equation*}
		
		But 
		
		\begin{equation*}
			\limsup\limits_{h \searrow 0} \frac{f( 0 + h) - f(0)}{h} = \infty \ ,
		\end{equation*}
		
		contradicting the differentiability of $ \varphi $ at zero. An analogous argument shows that $ D^{-}f(0) $ is empty.
		
		On the other hand, the function $ f - f = \hat{0} $ admits a superdifferential in zero, namely its classical derivative.
		
		The next subsection suggests a way to circumvent this problem.
		
	\subsection{A fundamental technique}
	
		 \subimport{doubling_device/}{doubling_motivation}
		 
		 We now borrow the idea of theorem \ref{density} to prove the difference $ w $ is a viscosity subsolution of \eqref{diff-PDE}. This involves approximating a given superdifferential of $ w $ at some point, as well as the point itself. Consequently; we require the Hamiltonian to be forgiving for approximation errors. That is, we assume
		 
		 \begin{equation}
		 \tag{H2}
		 \lvert H(t, x, p) - H(t, y, p) \rvert \leq \omega(R, \lvert x - y \rvert (1 + \lvert p \rvert)) \hbox{ for all } \ x, y \in B_R(0) \ ,
		 \label{eqn:H2}
		 \end{equation}
		 
		 where $ \omega : \left[0, \infty \right)^2 \to \left[0, \infty \right) $ describes some modulus of continuity. As assumption \eqref{eqn:H2} 
		 might seem far-fetched, we show in \ref{state hamiltonian} that the Hamiltonian, associated with our control problem, satisfies \eqref{eqn:H2} on account of the Lipschitz-conditions imposed upon the problem parameters (cf. \cite[p.~167]{zhou}). We are finally in a position to state theorem's \ref{smooth_loc} viscosity counterpart.
		 
		 \subimport{./}{viscosity_loc}
		 
		 We have already invoked, but not yet proved lemma \ref{doubling device}, which is no less important. We catch up on its proof without further ado.
		 
		 \subimport{doubling_device/}{doubling_lemma}
		 
		 This method of \emph{doubling the variables} goes back to Kru\v{z}kov who employed a similar function in \cite{kruvzkov}. It is this technique which also lies at the heart of Lions' and Crandall's uniqueness results for viscosity solutions, first introduced in \cite{lions}. \\
		 
		 We can now transfer our global comparison result for classical solutions, namely corollary \ref{Smooth Uniqueness}, to viscosity solutions. Once again, the global comparison result will rely on the local one. Since the local comparison result for viscosity solutions additionally entails assumption  \eqref{eqn:H2}, our global comparison result for viscosity solutions will also list \eqref{eqn:H2} among its prerequisites.
		  
		  \begin{corollary}
		  	\label{Viscosity Uniqueness}
		  	
		  	Let $ u $ and $ v \in C(\left[ 0, T \right] \times \mathbb{R}^{N}) $ be viscosity sub-and supersolutions, respectively, to some PDE of the form
		  	
		  	\begin{equation*}
		  	-u_t + H(t, x, -D_x u) = 0 \ ,
		  	\end{equation*}
		  	where $ H : \left[ 0, T \right] \times \mathbb{R}^{N} \times \mathbb{R}^{N+1} $ is continuous and satisfies \eqref{varying_Lipschitz} as well as \eqref{eqn:H2}.
		  	
		  	If the subsolution $ u $ is smaller or equal to the supersolution $ v $ over $ \{ T \} \times \mathbb{R}^{N} $, then the same applies to the whole domain $ \left[ 0, T \right] \times \mathbb{R}^{N} $.
		  	
		  	\begin{proof}
		  		The proof of corollary \ref{Smooth Uniqueness} only relied on the local comparison of sub-and supersolutions provided by theorem \ref{smooth_loc}. 
		  		
		  		According to theorem \ref{viscosity_loc}, theorem \ref{smooth_loc} still applies in the viscosity sense, given the additional assumptions. Consequently, the proof of corollary \ref{Smooth Uniqueness} can be repeated verbatim.
		  	\end{proof}
		  \end{corollary}
	  
	  Altogether, we can finally characterize the value function associated with our control problem as the unique viscosity solution of some terminal value problem, with Hamilton-Jacobi-Bellman type PDE.
	  
	  \begin{theorem}
	  	\label{value characterization}
	  	Let $ \mathcal{A} $ be a metric space. Suppose the running cost function $ f $, the dynamics $ b $ and the terminal cost function $ h $ are uniformly continuous, and admit estimates as in \eqref{bounded} and \eqref{Lipschitz} for some constant $ L \geq 0 $. Then the value function $ v $ is the unique viscosity solution to the terminal value problem with PDE
	  	
	  	\begin{equation*}
	  	-v_t + H(t, x, -D_x v) = 0 \ ,
	  	\end{equation*}
	  	
	  	and terminal condition
	  	
	  	\begin{equation*}
	  	v(T, \cdot) = h \ ,
	  	\end{equation*}
	  	
	  	where $ H $ denotes the Hamiltonian of the control problem, given by the mapping $ (t, x, p) \mapsto \sup\limits_{a \in \mathcal{A}} \bigg\{ p^{T} b(t, x, a) - f(t, x, a) \bigg\} $.
	  	
	  	\begin{proof}
	  		It has already been proved in theorem \ref{viscosity solution HJB}, that the value function $ v $ is viscosity solution to the given terminal value problem. 
	  		
	  		As stated in theorem \ref{classical solution HJB}, the uniform continuity of $ f $ and $ b $, and condition \eqref{Lipschitz}, imposed upon them, imply the continuity of $ H $. Furthermore, we derived in \ref{Hamiltonian gradient} and \ref{state hamiltonian}, estimates of the form \eqref{varying_Lipschitz} and \eqref{eqn:H2}, respectively. Consequently, the assumptions made in corollary \ref{Viscosity Uniqueness} hold for the Hamiltonian of our control problem. On the other hand, corollary \ref{Viscosity Uniqueness} immediately implies $ v $ is the \emph{unique} viscosity solution to the terminal value problem.
	  	\end{proof}
	  \end{theorem}
		  